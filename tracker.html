<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Phone GPS Tracker</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 16px;
      color: #fff;
    }
    .container { max-width: 420px; margin: 0 auto; }
    .card {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 14px;
    }
    .title { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
    .subtitle { font-size: 13px; color: #94a3b8; }
    .warning {
      background: rgba(251,191,36,0.15);
      border: 1px solid rgba(251,191,36,0.4);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      font-size: 12px;
      color: #fcd34d;
      line-height: 1.6;
    }
    .warning strong { color: #fbbf24; display: block; margin-bottom: 4px; font-size: 13px; }
    label { font-size: 12px; color: #94a3b8; display: block; margin-bottom: 6px; }
    input[type=text] {
      width: 100%;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 10px 12px;
      color: #fff;
      font-size: 14px;
    }
    input[type=text]:disabled { opacity: 0.5; }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%;
      display: inline-block; margin-right: 8px;
      background: #64748b;
    }
    .status-dot.active { background: #22c55e; box-shadow: 0 0 8px #22c55e; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    .status-label { font-weight: 600; font-size: 15px; vertical-align: middle; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .stat {
      background: rgba(255,255,255,0.06);
      border-radius: 8px;
      padding: 10px;
    }
    .stat-label { font-size: 11px; color: #64748b; margin-bottom: 2px; }
    .stat-value { font-size: 13px; font-weight: 600; font-family: monospace; color: #e2e8f0; }
    .sent-ok { color: #22c55e; font-size: 12px; margin-top: 10px; }
    .error-box {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.4);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      color: #f87171;
      margin-top: 10px;
    }
    .btn {
      width: 100%;
      border: none;
      border-radius: 14px;
      padding: 18px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: opacity 0.2s;
    }
    .btn:active { opacity: 0.8; }
    .btn-start { background: #2563eb; color: #fff; }
    .btn-stop  { background: #dc2626; color: #fff; }
    .footer { text-align: center; margin-top: 16px; font-size: 12px; color: #475569; }
  </style>
</head>
<body>
  <div class="container">

    <div class="card">
      <div class="title">üì° Phone GPS Tracker</div>
      <div class="subtitle">Sends your location to the fleet dashboard</div>
    </div>

    <div class="warning">
      <strong>‚ö†Ô∏è iOS Safari Notice</strong>
      iOS Safari stops GPS when the screen locks. Keep this page open and screen awake while tracking. For best results use Chrome on Android.
    </div>

    <div class="card">
      <label>Device ID (shown on map)</label>
      <input type="text" id="deviceId" value="phone-1" />
    </div>

    <div class="card">
      <div>
        <span class="status-dot" id="dot"></span>
        <span class="status-label" id="statusLabel">Not Tracking</span>
      </div>
      <div class="grid" id="statsGrid" style="display:none">
        <div class="stat"><div class="stat-label">Latitude</div><div class="stat-value" id="lat">‚Äî</div></div>
        <div class="stat"><div class="stat-label">Longitude</div><div class="stat-value" id="lng">‚Äî</div></div>
        <div class="stat"><div class="stat-label">Speed</div><div class="stat-value" id="speed">‚Äî</div></div>
        <div class="stat"><div class="stat-label">Heading</div><div class="stat-value" id="heading">‚Äî</div></div>
        <div class="stat"><div class="stat-label">Accuracy</div><div class="stat-value" id="accuracy">‚Äî</div></div>
        <div class="stat"><div class="stat-label">Sent</div><div class="stat-value" id="count">0 times</div></div>
      </div>
      <div class="sent-ok" id="lastSent" style="display:none"></div>
      <div class="error-box" id="errorBox" style="display:none"></div>
    </div>

    <button class="btn btn-start" id="startBtn" onclick="startTracking()">‚ñ∂ Start Tracking</button>
    <button class="btn btn-stop" id="stopBtn" onclick="stopTracking()" style="display:none">‚èπ Stop Tracking</button>

    <div class="footer">View live position on the dashboard GPS map</div>
  </div>

  <script>
    let watchId = null;
    let sendCount = 0;

    function el(id) { return document.getElementById(id); }

    function showError(msg) {
      el('errorBox').textContent = '‚ö†Ô∏è ' + msg;
      el('errorBox').style.display = 'block';
    }

    function clearError() {
      el('errorBox').style.display = 'none';
    }

    async function sendLocation(pos) {
      const deviceId = el('deviceId').value.trim() || 'phone-1';
      const data = {
        deviceId,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        accuracy: pos.coords.accuracy ?? null,
        speed: pos.coords.speed != null ? pos.coords.speed * 3.6 : null,
        heading: pos.coords.heading ?? null,
        timestamp: Date.now()
      };

      // Update UI
      el('statsGrid').style.display = 'grid';
      el('lat').textContent = data.lat.toFixed(6);
      el('lng').textContent = data.lng.toFixed(6);
      el('speed').textContent = data.speed != null ? data.speed.toFixed(1) + ' km/h' : '‚Äî';
      el('heading').textContent = data.heading != null ? data.heading.toFixed(0) + '¬∞' : '‚Äî';
      el('accuracy').textContent = data.accuracy != null ? '¬±' + data.accuracy.toFixed(0) + 'm' : '‚Äî';

      try {
        const res = await fetch('https://employee-po-app.onrender.com/api/phone-location', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        sendCount++;
        el('count').textContent = sendCount + ' times';
        el('lastSent').textContent = '‚úì Last sent: ' + new Date().toLocaleTimeString();
        el('lastSent').style.display = 'block';
        clearError();

        // Update service worker with latest position
        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({
            type: 'UPDATE_POSITION',
            position: {
              lat: data.lat,
              lng: data.lng,
              accuracy: data.accuracy,
              speed: data.speed,
              heading: data.heading
            }
          });
        }
      } catch(err) {
        showError('Send failed: ' + err.message);
      }
    }

    function startTracking() {
      if (!navigator.geolocation) {
        showError('Geolocation not supported by this browser');
        return;
      }
      clearError();
      el('deviceId').disabled = true;
      el('startBtn').style.display = 'none';
      el('stopBtn').style.display = 'flex';
      el('dot').classList.add('active');
      el('statusLabel').textContent = 'üì± Tracking Active (Screen Awake)';

      // Keep screen awake to prevent GPS stopping
      if ('wakeLock' in navigator) {
        navigator.wakeLock.request('screen').then(lock => {
          wakeLock = lock;
          console.log('Screen wake lock activated');
        }).catch(err => {
          console.log('Wake lock failed:', err);
        });
      }

      watchId = navigator.geolocation.watchPosition(
        function(pos) { lastPosition = pos; sendLocation(pos); },
        function(err) {
          showError('GPS error: ' + err.message);
          stopTracking();
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );

      // Re-send last known position every 1s so dashboard stays fresh
      resendInterval = setInterval(function() {
        if (lastPosition) sendLocation(lastPosition);
      }, 1000);
    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (resendInterval !== null) {
        clearInterval(resendInterval);
        resendInterval = null;
      }
      
      // Release wake lock
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
        console.log('Screen wake lock released');
      }
      
      el('deviceId').disabled = false;
      el('startBtn').style.display = 'flex';
      el('stopBtn').style.display = 'none';
      el('dot').classList.remove('active');
      el('statusLabel').textContent = 'Tracking Stopped';
    }
  </script>
</body>
</html>
